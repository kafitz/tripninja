L.Playback=L.Playback||{},L.Playback.Util=L.Class.extend({statics:{DateStr:function(a){return new Date(a).toDateString()},TimeStr:function(a){var b=new Date(a),c=b.getHours(),d=b.getMinutes(),e=b.getSeconds(),f=a/1e3,g=(f-Math.floor(f)).toFixed(2).slice(1),h="AM";return c>11&&(c%=12,h="PM"),0===c&&(c=12),10>d&&(d="0"+d),10>e&&(e="0"+e),c+":"+d+":"+e+g+" "+h},ParseGPX:function(a){for(var b={type:"Feature",geometry:{type:"MultiPoint",coordinates:[]},properties:{time:[],speed:[],altitude:[]},bbox:[]},c=$.parseXML(a),d=$(c).find("trkpt"),e=0,f=d.length;f>e;e++){var g=d[e],h=parseFloat(g.getAttribute("lat")),i=parseFloat(g.getAttribute("lon")),j=$(g).find("time").text(),k=$(g).find("ele").text(),l=new Date(j).getTime(),m=parseFloat(k),n=b.geometry.coordinates,o=b.properties,p=o.time,q=b.properties.altitude;n.push([i,h]),p.push(l),q.push(m)}return b}}}),L.Playback=L.Playback||{},L.Playback.MoveableMarker=L.Marker.extend({initialize:function(a,b,c){var d=b.marker||{};jQuery.isFunction(d)&&(d=d(c)),L.Marker.prototype.initialize.call(this,a,d),this.popupContent="",d.getPopup&&(this.popupContent=d.getPopup(c)),this.bindPopup(this.getPopupContent()+a.toString())},getPopupContent:function(){return""!=this.popupContent?"<b>"+this.popupContent+"</b><br/>":""},move:function(a,b){L.DomUtil.TRANSITION&&(this._icon&&(this._icon.style[L.DomUtil.TRANSITION]="all "+b+"ms linear",this._popup&&this._popup._wrapper&&(this._popup._wrapper.style[L.DomUtil.TRANSITION]="all "+b+"ms linear")),this._shadow&&(this._shadow.style[L.DomUtil.TRANSITION]="all "+b+"ms linear")),this.setLatLng(a),this._popup&&this._popup.setContent(this.getPopupContent()+this._latlng.toString())}}),L.Playback=L.Playback||{},L.Playback.Track=L.Class.extend({initialize:function(a,b){b=b||{};var c=b.tickLen||250;this._geoJSON=a,this._tickLen=c,this._ticks=[],this._marker=null;var d,e,f=a.properties.time,g=a.geometry.coordinates,h=g[0],i=g[1],j=currSampleTime=f[0],k=f[1],l=j%c;if(1===f.length)return 0!==l&&(j+=c-l),this._ticks[j]=g[0],this._startTime=j,void(this._endTime=j);for(0!==l?(d=c-l,e=d/(k-currSampleTime),j+=d,this._ticks[j]=this._interpolatePoint(h,i,e)):this._ticks[j]=h,this._startTime=j,j+=c;k>j;)e=(j-currSampleTime)/(k-currSampleTime),this._ticks[j]=this._interpolatePoint(h,i,e),j+=c;for(var m=1,n=g.length;n>m;m++)for(h=g[m],i=g[m+1],j=currSampleTime=f[m],k=f[m+1],l=j%c,0!=l&&k?(d=c-l,e=d/(k-currSampleTime),j+=d,this._ticks[j]=this._interpolatePoint(h,i,e)):this._ticks[j]=h,j+=c;k>j;)e=(j-currSampleTime)/(k-currSampleTime),this._ticks[j]=k-currSampleTime>b.maxInterpolationTime?h:this._interpolatePoint(h,i,e),j+=c;this._endTime=j-c,this._lastTick=this._ticks[this._endTime]},_interpolatePoint:function(a,b,c){try{var d=[b[0]-a[0],b[1]-a[1]],e=[d[0]*c,d[1]*c];return[a[0]+e[0],a[1]+e[1]]}catch(f){console.log("err: cant interpolate a point"),console.log(["start",a]),console.log(["end",b]),console.log(["ratio",c])}},getFirstTick:function(){return this._ticks[this._startTime]},getLastTick:function(){return this._ticks[this._endTime]},getStartTime:function(){return this._startTime},getEndTime:function(){return this._endTime},getTickMultiPoint:function(){for(var a=this.getStartTime(),b=this.getEndTime(),c=[],d=[];b>=a;)d.push(a),c.push(this.tick(a)),a+=this._tickLen;return{type:"Feature",geometry:{type:"MultiPoint",coordinates:c},properties:{time:d}}},tick:function(a){return a>this._endTime&&(a=this._endTime),a<this._startTime&&(a=this._startTime),this._ticks[a]},setMarker:function(a,b){var c=null;if(c=a?this.tick(a):this.getFirstTick()){var d=new L.LatLng(c[1],c[0]);this._marker=new L.Playback.MoveableMarker(d,b,this._geoJSON)}return this._marker},moveMarker:function(a,b){this._marker&&this._marker.move(a,b)},getMarker:function(){return this._marker}}),L.Playback=L.Playback||{},L.Playback.TrackController=L.Class.extend({initialize:function(a,b,c){this.options=c||{},this._map=a,this._tracks=[],this.setTracks(b)},clearTracks:function(){for(;this._tracks.length>0;){var a=this._tracks.pop(),b=a.getMarker();b&&this._map.removeLayer(b)}},setTracks:function(a){this.clearTracks(),this.addTracks(a)},addTracks:function(a){if(a)if(a instanceof Array)for(var b=0,c=a.length;c>b;b++)this.addTrack(a[b]);else this.addTrack(a)},addTrack:function(a,b){if(a){var c=a.setMarker(b,this.options);c&&(c.addTo(this._map),this._tracks.push(a))}},tock:function(a,b){for(var c=0,d=this._tracks.length;d>c;c++){var e=this._tracks[c].tick(a),f=new L.LatLng(e[1],e[0]);this._tracks[c].moveMarker(f,b)}},getStartTime:function(){var a=0;if(this._tracks.length>0){a=this._tracks[0].getStartTime();for(var b=1,c=this._tracks.length;c>b;b++){var d=this._tracks[b].getStartTime();a>d&&(a=d)}}return a},getEndTime:function(){var a=0;if(this._tracks.length>0){a=this._tracks[0].getEndTime();for(var b=1,c=this._tracks.length;c>b;b++){var d=this._tracks[b].getEndTime();d>a&&(a=d)}}return a},getTracks:function(){return this._tracks}}),L.Playback=L.Playback||{},L.Playback.Clock=L.Class.extend({initialize:function(a,b,c){this._trackController=a,this._callbacksArry=[],b&&this.addCallback(b),L.setOptions(this,c),this._speed=this.options.speed,this._tickLen=this.options.tickLen,this._cursor=a.getStartTime(),this._transitionTime=this._tickLen/this._speed},_tick:function(a){return a._cursor>a._trackController.getEndTime()?void clearInterval(a._intervalID):(a._trackController.tock(a._cursor,a._transitionTime),a._callbacks(a._cursor),void(a._cursor+=a._tickLen))},_callbacks:function(a){for(var b=this._callbacksArry,c=0,d=b.length;d>c;c++)b[c](a)},addCallback:function(a){this._callbacksArry.push(a)},start:function(){this._intervalID||(this._intervalID=window.setInterval(this._tick,this._transitionTime,this))},stop:function(){this._intervalID&&(clearInterval(this._intervalID),this._intervalID=null)},getSpeed:function(){return this._speed},isPlaying:function(){return this._intervalID?!0:!1},setSpeed:function(a){this._speed=a,this._transitionTime=this._tickLen/a,this._intervalID&&(this.stop(),this.start())},setCursor:function(a){var b=parseInt(a);if(b){var c=b%this._tickLen;0!==c&&(b+=this._tickLen-c),this._cursor=b,this._trackController.tock(this._cursor,0),this._callbacks(this._cursor)}},getTime:function(){return this._cursor},getStartTime:function(){return this._trackController.getStartTime()},getEndTime:function(){return this._trackController.getEndTime()},getTickLen:function(){return this._tickLen}}),L.Playback=L.Playback||{},L.Playback.TracksLayer=L.Class.extend({initialize:function(a,b){var c=b.layer||{};jQuery.isFunction(c)&&(c=c(feature)),c.pointToLayer||(c.pointToLayer=function(a,b){return new L.CircleMarker(b,{radius:5})}),this.layer=new L.GeoJSON(null,c);var d={"GPS Tracks":this.layer};L.control.layers(null,d,{collapsed:!1}).addTo(a)},clearLayer:function(){for(var a in this.layer._layers)this.layer.removeLayer(this.layer._layers[a])},addLayer:function(a){this.layer.addData(a)}}),L.Playback=L.Playback||{},L.Playback.DateControl=L.Control.extend({options:{position:"bottomleft"},initialize:function(a){this.playback=a},onAdd:function(){this._container=L.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var a=this,b=this.playback,c=b.getTime(),d=L.DomUtil.create("div","datetimeControl",this._container);return this._date=L.DomUtil.create("p","",d),this._time=L.DomUtil.create("p","",d),this._date.innerHTML=L.Playback.Util.DateStr(c),this._time.innerHTML=L.Playback.Util.TimeStr(c),b.addCallback(function(b){a._date.innerHTML=L.Playback.Util.DateStr(b),a._time.innerHTML=L.Playback.Util.TimeStr(b)}),this._container}}),L.Playback.PlayControl=L.Control.extend({options:{position:"bottomright"},initialize:function(a){this.playback=a},onAdd:function(){function a(){c.isPlaying()?(c.stop(),b._button.innerHTML="Play"):(c.start(),b._button.innerHTML="Stop")}this._container=L.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var b=this,c=this.playback;c.setSpeed(100);var d=L.DomUtil.create("div","playControl",this._container);this._button=L.DomUtil.create("button","",d),this._button.innerHTML="Play";var e=L.DomEvent.stopPropagation;return L.DomEvent.on(this._button,"click",e).on(this._button,"mousedown",e).on(this._button,"dblclick",e).on(this._button,"click",L.DomEvent.preventDefault).on(this._button,"click",a,this),this._container}}),L.Playback.SliderControl=L.Control.extend({options:{position:"bottomleft"},initialize:function(a){this.playback=a},onAdd:function(a){function b(a){var b=Number(a.target.value);d.setCursor(b)}this._container=L.DomUtil.create("div","leaflet-control-layers leaflet-control-layers-expanded");var c=this,d=this.playback;this._slider=L.DomUtil.create("input","slider",this._container),this._slider.type="range",this._slider.min=d.getStartTime(),this._slider.max=d.getEndTime(),this._slider.value=d.getTime();var e=L.DomEvent.stopPropagation;return L.DomEvent.on(this._slider,"click",e).on(this._slider,"mousedown",e).on(this._slider,"dblclick",e).on(this._slider,"click",L.DomEvent.preventDefault).on(this._slider,"change",b,this).on(this._slider,"mousemove",b,this),d.addCallback(function(a){c._slider.value=a}),a.on("playback:add_tracks",function(){c._slider.min=d.getStartTime(),c._slider.max=d.getEndTime(),c._slider.value=d.getTime()}),this._container}}),L.Playback=L.Playback.Clock.extend({statics:{MoveableMarker:L.Playback.MoveableMarker,Track:L.Playback.Track,TrackController:L.Playback.TrackController,Clock:L.Playback.Clock,Util:L.Playback.Util,TracksLayer:L.Playback.TracksLayer,PlayControl:L.Playback.PlayControl,DateControl:L.Playback.DateControl,SliderControl:L.Playback.SliderControl},options:{tickLen:250,speed:1,maxInterpolationTime:3e5,tracksLayer:!0,playControl:!1,dateControl:!1,sliderControl:!1,layer:{},marker:{}},initialize:function(a,b,c,d){L.setOptions(this,d),this._map=a,this._trackController=new L.Playback.TrackController(a,null,this.options),L.Playback.Clock.prototype.initialize.call(this,this._trackController,c,this.options),this.options.tracksLayer&&(this._tracksLayer=new L.Playback.TracksLayer(a,d)),this.setData(b),this.options.playControl&&(this.playControl=new L.Playback.PlayControl(this),this.playControl.addTo(a)),this.options.sliderControl&&(this.sliderControl=new L.Playback.SliderControl(this),this.sliderControl.addTo(a)),this.options.dateControl&&(this.dateControl=new L.Playback.DateControl(this),this.dateControl.addTo(a))},clearData:function(){this._trackController.clearTracks(),this._tracksLayer&&this._tracksLayer.clearLayer()},setData:function(a){this.clearData(),this.addData(a,this.getTime()),this.setCursor(this.getStartTime())},addData:function(a,b){if(a){if(a instanceof Array)for(var c=0,d=a.length;d>c;c++)this._trackController.addTrack(new L.Playback.Track(a[c],this.options),b);else this._trackController.addTrack(new L.Playback.Track(a,this.options),b);this._map.fire("playback:set:data"),this.options.tracksLayer&&this._tracksLayer.addLayer(a)}}}),L.Map.addInitHook(function(){this.options.playback&&(this.playback=new L.Playback(this))}),L.playback=function(a,b,c,d){return new L.Playback(a,b,c,d)};